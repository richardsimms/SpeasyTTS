import { useEffect, useState } from "react";
import useSWR from "swr";
import { Card } from "@/components/ui/card";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Button } from "@/components/ui/button";
import { Moon, Sun } from "lucide-react";
import ArticleInput from "../components/ArticleInput";
import ConversionStatus from "../components/ConversionStatus";
import AudioPlayerOverlay from "../components/AudioPlayerOverlay";
import { getArticles } from "../lib/api";
import type { Article } from "../../../db/schema";

export default function Dashboard() {
  const { data: articles, mutate } = useSWR("/api/articles", getArticles);
  const [selectedArticle, setSelectedArticle] = useState<Article | null>(null);

  useEffect(() => {
    const interval = setInterval(() => {
      mutate();
    }, 5000);
    return () => clearInterval(interval);
  }, [mutate]);

  const toggleTheme = () => {
    const html = document.documentElement;
    const currentTheme = html.classList.contains("dark") ? "light" : "dark";
    html.classList.remove("light", "dark");
    html.classList.add(currentTheme);
  };

  return (

    <div className="min-h-screen bg-gradient-to-b from-background to-background/95">

      <div className="mx-auto max-w-[700px] mx-auto p-6 pb-24">
        <div className="flex justify-between items-center mb-8">
   
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="200"
            height="80"
            viewBox="0 0 340 120"
            version="1.2"
          >      
          <path d="M27.3828 86.1719C22.6172 86.1719 18.5547 85.7812 15.1953 85C11.875 84.2578 9.14062 83.2227 6.99219 81.8945C4.84375 80.6055 3.28125 79.1211 2.30469 77.4414C1.32812 75.7227 0.839844 73.9258 0.839844 72.0508C0.839844 68.0273 2.75391 64.1406 6.58203 60.3906C8.41797 58.5938 10.5859 56.9922 13.0859 55.5859C15.625 54.1797 18.418 53.1055 21.4648 52.3633C22.5977 52.3633 23.418 52.832 23.9258 53.7695C24.4727 54.668 24.7461 55.7031 24.7461 56.875C24.7461 58.0078 24.4727 58.9062 23.9258 59.5703C23.3789 60.1953 22.1289 60.918 20.1758 61.7383C17.9883 62.6758 16.2695 63.8086 15.0195 65.1367C13.7695 66.4258 13.1445 67.7148 13.1445 69.0039C13.1445 70.6445 14.2773 72.0898 16.543 73.3398C18.8477 74.5508 22.5977 75.1562 27.793 75.1562C31.3867 75.1562 34.6875 74.5898 37.6953 73.457C40.7422 72.3242 43.1836 70.7812 45.0195 68.8281C46.8555 66.8359 47.7734 64.5898 47.7734 62.0898C47.7734 60.6836 47.1875 59.2188 46.0156 57.6953C44.8438 56.1719 42.9883 54.5898 40.4492 52.9492C38.1836 51.4648 36.1914 50.1367 34.4727 48.9648C32.793 47.793 31.3867 46.7578 30.2539 45.8594L25.918 42.4609C22.9883 39.8828 20.8008 37.4023 19.3555 35.0195C17.9102 32.6367 17.1875 30.1562 17.1875 27.5781C17.1875 24.0625 18.418 20.6836 20.8789 17.4414C23.3398 14.1602 26.5039 11.2305 30.3711 8.65234C34.2383 6.11328 38.3594 4.12109 42.7344 2.67578C47.1094 1.19141 51.1523 0.449219 54.8633 0.449219C58.6914 0.449219 61.875 1.34766 64.4141 3.14453C66.9922 4.94141 68.2812 7.85156 68.2812 11.875C68.2812 17.8516 64.8828 23.125 58.0859 27.6953C56.5625 28.75 55.1562 29.2773 53.8672 29.2773C52.5391 29.2773 51.4844 28.8086 50.7031 27.8711C49.9219 26.8945 49.5312 25.7617 49.5312 24.4727C49.5312 23.3789 49.8438 22.2852 50.4688 21.1914C51.1328 20.0977 52.1875 19.1602 53.6328 18.3789C54.7656 17.793 55.7617 17.0117 56.6211 16.0352C57.5195 15.0195 57.9688 14.043 57.9688 13.1055C57.9688 12.207 57.6562 11.6211 57.0312 11.3477C56.4453 11.0742 55.7227 10.9375 54.8633 10.9375C52.4414 10.9375 49.7266 11.3672 46.7188 12.2266C43.7109 13.0859 40.8398 14.2578 38.1055 15.7422C35.2148 17.3047 32.9102 19.0039 31.1914 20.8398C29.5117 22.6758 28.6719 24.4922 28.6719 26.2891C28.6719 27.9688 29.3555 29.5117 30.7227 30.918C32.1289 32.3242 34.1016 33.9648 36.6406 35.8398L50.3516 45.9766C53.7109 48.4766 56.4062 50.9375 58.4375 53.3594C60.4688 55.7422 61.4844 58.3398 61.4844 61.1523C61.4844 65.293 60.0586 69.2773 57.207 73.1055C54.3945 76.9336 50.4297 80.0781 45.3125 82.5391C40.2344 84.9609 34.2578 86.1719 27.3828 86.1719Z" class="text-secondary fill-current"/>
          <path d="M55.6789 114.766C54.2727 114.766 53.1203 114.473 52.2219 113.887C51.2844 113.34 50.8156 112.266 50.8156 110.664C50.8156 109.141 51.2258 107.52 52.0461 105.801C52.8664 104.082 53.5695 102.578 54.1555 101.289C56.8898 96.25 59.7023 91.0938 62.593 85.8203C65.4836 80.5859 68.1789 75.4297 70.6789 70.3516C73.218 65.2734 75.2492 60.4492 76.7727 55.8789C77.0461 55.2539 77.4367 54.3359 77.9445 53.125C78.4523 51.875 79.0773 50.5859 79.8195 49.2578C80.5617 47.9297 81.382 46.7969 82.2805 45.8594C83.1789 44.9219 84.1359 44.4531 85.1516 44.4531C88.1203 44.4531 89.6047 45.6445 89.6047 48.0273C89.6047 48.457 89.468 49.3555 89.1945 50.7227C88.9602 52.0508 88.7063 52.9688 88.4328 53.4766C90.3469 51.7188 92.4563 50 94.7609 48.3203C97.0656 46.6016 99.468 45.1953 101.968 44.1016C104.507 42.9688 107.007 42.4023 109.468 42.4023C112.046 42.4023 114.448 43.0273 116.675 44.2773C118.941 45.4883 120.073 47.3047 120.073 49.7266C120.073 52.0312 119.077 54.6094 117.085 57.4609C115.132 60.2734 112.886 63.0078 110.347 65.6641C108.863 67.2266 107.359 68.75 105.835 70.2344C104.312 71.6797 103.023 72.9297 101.968 73.9844C100.952 75.0391 100.425 75.7422 100.386 76.0938C100.386 77.1484 101.148 77.6758 102.671 77.6758C104.234 77.6758 107.456 75.9961 112.339 72.6367C117.222 69.2383 124.136 64.1797 133.081 57.4609C134.292 56.7578 135.249 56.4062 135.952 56.4062C136.812 56.4062 137.456 56.7383 137.886 57.4023C138.316 58.0273 138.53 58.8086 138.53 59.7461C138.53 60.7617 138.257 61.7969 137.71 62.8516C137.202 63.9062 136.421 64.7852 135.366 65.4883C131.304 68.4961 127.573 71.3477 124.175 74.043C120.855 76.6602 117.769 78.8672 114.917 80.6641C111.988 82.5391 109.136 83.9844 106.363 85C103.589 86.0156 100.62 86.5234 97.4563 86.5234C94.4875 86.5234 92.1828 85.9766 90.5422 84.8828C88.9406 83.7891 88.1398 82.2852 88.1398 80.3711V79.9023L88.1984 79.4336C88.4328 77.7148 89.5852 75.625 91.6555 73.1641C93.7648 70.6641 96.0695 68.1641 98.5695 65.6641C100.991 63.2422 103.198 60.9375 105.191 58.75C107.183 56.5625 108.179 54.8828 108.179 53.7109C108.179 52.6953 107.339 52.1875 105.659 52.1875C103.355 52.1875 100.933 52.9102 98.3938 54.3555C95.8938 55.8008 93.4914 57.6562 91.1867 59.9219C88.8039 62.1875 86.6945 64.5508 84.8586 67.0117C83.0227 69.4727 81.4992 71.7578 80.2883 73.8672L76.3039 81.3086C75.4055 82.9883 74.6242 84.4531 73.9602 85.7031C73.3352 86.9531 72.9055 87.793 72.6711 88.2227C72.3977 88.7305 71.8703 89.8438 71.0891 91.5625C70.3469 93.2812 69.4289 95.3516 68.3352 97.7734C67.2414 100.156 66.3039 102.207 65.5227 103.926C64.7805 105.684 64.3313 106.797 64.175 107.266C63.4328 109.258 62.3781 110.996 61.0109 112.48C59.6438 114.004 57.8664 114.766 55.6789 114.766Z" class="text-foreground fill-current"/>
          <path d="M143.682 86.4648C140.557 86.4648 137.881 85.7031 135.655 84.1797C133.467 82.6172 131.788 80.5859 130.616 78.0859C129.483 75.5469 128.916 72.832 128.916 69.9414C128.916 67.4023 129.639 64.5703 131.084 61.4453C132.569 58.2812 134.678 55.2539 137.413 52.3633C140.147 49.4727 143.409 47.0898 147.198 45.2148C151.026 43.3008 155.186 42.3438 159.678 42.3438C162.92 42.3438 165.342 43.125 166.944 44.6875C168.545 46.25 169.346 48.418 169.346 51.1914C169.346 52.832 168.916 54.5508 168.057 56.3477C167.198 58.1445 165.713 59.9609 163.604 61.7969C161.495 63.6719 158.663 65.5859 155.108 67.5391C151.592 69.4531 147.178 71.3867 141.866 73.3398C142.295 75.7617 144.248 76.9727 147.725 76.9727C150.42 76.9727 153.33 76.4258 156.455 75.332C159.58 74.1992 162.588 72.9102 165.479 71.4648C168.37 70.0586 170.85 68.7305 172.92 67.4805C174.991 66.2305 176.221 65.5273 176.612 65.3711C176.963 65.1367 177.276 65 177.549 64.9609C177.862 64.9219 178.135 64.9023 178.37 64.9023C179.307 64.9023 179.952 65.2734 180.303 66.0156C180.694 66.7188 180.889 67.3047 180.889 67.7734C180.889 68.125 180.85 68.5547 180.772 69.0625C180.694 69.5312 180.401 70.0781 179.893 70.7031C179.385 71.2109 177.901 72.3242 175.44 74.043C172.979 75.7617 170.342 77.4219 167.53 79.0234C164.092 80.9375 160.264 82.6562 156.045 84.1797C151.827 85.7031 147.705 86.4648 143.682 86.4648ZM140.987 66.6016C143.526 65.2734 146.104 63.7305 148.721 61.9727C151.377 60.1758 153.389 58.8672 154.756 58.0469C156.592 56.875 157.803 55.8398 158.389 54.9414C159.053 53.9648 159.385 53.1445 159.385 52.4805C159.385 51.8945 159.19 51.4258 158.799 51.0742C158.448 50.7227 158.038 50.5078 157.569 50.4297L157.041 50.3711H156.514C154.366 50.3711 152.373 50.9961 150.538 52.2461C148.741 53.457 147.217 54.9805 145.967 56.8164C144.639 58.7305 143.565 60.5273 142.745 62.207C141.963 63.8867 141.377 65.3516 140.987 66.6016Z"  fill="text-foreground"/>
          <path d="M188.56 86.4648C187.232 86.4648 185.65 86.0938 183.814 85.3516C181.978 84.6094 180.357 83.3789 178.951 81.6602C177.584 79.9414 176.9 77.6367 176.9 74.7461C176.9 72.3242 177.447 69.2969 178.541 65.6641C179.634 62.0312 181.353 58.457 183.697 54.9414C186.041 51.3477 189.029 48.3594 192.662 45.9766C196.334 43.5938 200.572 42.4023 205.377 42.4023C207.095 42.4023 208.599 42.6172 209.888 43.0469C211.177 43.4766 212.271 43.9453 213.17 44.4531C213.677 44.7656 214.146 45.0977 214.576 45.4492C215.045 45.7617 215.474 46.1133 215.865 46.5039L217.916 45.5078C218.502 45.2344 219.107 45 219.732 44.8047C220.396 44.5703 220.962 44.4531 221.431 44.4531C222.916 44.4531 224.127 44.8633 225.064 45.6836C226.002 46.5039 226.47 47.4023 226.47 48.3789C226.47 48.6914 226.451 48.9062 226.412 49.0234C226.138 50.1172 225.63 51.6211 224.888 53.5352C224.185 55.4492 223.423 57.5781 222.603 59.9219C221.783 62.1875 221.08 64.375 220.494 66.4844C219.947 68.5938 219.673 70.332 219.673 71.6992C219.673 72.8711 219.869 73.8477 220.259 74.6289C220.65 75.3711 221.314 75.7422 222.252 75.7422C223.384 75.7422 224.908 75.0977 226.822 73.8086C228.736 72.4805 230.709 70.918 232.74 69.1211C233.834 68.1445 234.966 67.1094 236.138 66.0156C237.31 64.8828 238.502 63.6914 239.712 62.4414C240.337 61.9336 240.943 61.6797 241.529 61.6797C242.31 61.6797 242.955 62.0703 243.462 62.8516C244.009 63.5938 244.283 64.4336 244.283 65.3711C244.283 66.4648 243.912 67.3828 243.17 68.125C241.607 69.5703 240.005 71.1133 238.365 72.7539C236.724 74.3945 234.459 76.4062 231.568 78.7891C228.99 80.8984 226.334 82.7148 223.599 84.2383C220.865 85.7227 218.404 86.4648 216.216 86.4648C213.482 86.4648 211.49 85.4102 210.24 83.3008C208.99 81.1523 208.365 78.8672 208.365 76.4453C208.365 74.6875 208.619 73.125 209.127 71.7578C207.525 73.9062 205.63 76.1328 203.443 78.4375C201.255 80.7031 198.892 82.6172 196.353 84.1797C193.814 85.7031 191.216 86.4648 188.56 86.4648ZM193.248 76.1523C194.498 76.1523 196.06 75.3516 197.935 73.75C199.849 72.1484 201.685 70.2734 203.443 68.125C205.396 65.7812 206.939 63.6523 208.072 61.7383C209.205 59.8242 209.771 58.5352 209.771 57.8711C209.771 56.3867 208.912 55.2148 207.193 54.3555C205.474 53.457 203.931 53.0078 202.564 53.0078C200.142 53.0078 197.837 53.7891 195.65 55.3516C193.502 56.9141 191.744 58.9258 190.377 61.3867C189.009 63.8086 188.326 66.3281 188.326 68.9453C188.326 70.4688 188.599 72.0508 189.146 73.6914C189.732 75.332 191.099 76.1523 193.248 76.1523Z"  fill="currentColor"/>
          <path d="M251.954 86.4648C247.852 86.4648 244.122 85.5469 240.762 83.7109C237.403 81.8359 235.255 78.8867 234.317 74.8633C234.239 74.4727 234.2 74.2188 234.2 74.1016C234.2 73.0469 234.571 72.1484 235.313 71.4062C236.055 70.625 236.876 70.2344 237.774 70.2344C238.204 70.2344 238.673 70.3125 239.18 70.4688C239.727 70.625 240.137 70.9766 240.411 71.5234C241.427 73.3594 243.165 74.8438 245.626 75.9766C248.126 77.0703 250.567 77.6172 252.95 77.6172C255.489 77.6172 257.696 77.1289 259.571 76.1523C261.485 75.1758 262.442 73.5742 262.442 71.3477C262.442 68.6133 261.661 66.1914 260.098 64.082C258.575 61.9727 256.641 60.0781 254.298 58.3984C251.993 56.6797 249.669 55.0977 247.325 53.6523C247.13 53.5352 246.837 53.2031 246.446 52.6562C246.055 52.0703 245.86 51.4844 245.86 50.8984C245.86 50.4297 245.977 50.0586 246.212 49.7852C247.462 48.1055 249.063 46.4648 251.016 44.8633C252.97 43.2617 255.118 42.4609 257.462 42.4609C259.18 42.4609 260.587 42.8906 261.68 43.75C262.813 44.5703 263.38 45.3906 263.38 46.2109C263.38 47.3047 262.872 48.3398 261.856 49.3164C260.841 50.2539 259.786 51.1523 258.692 52.0117C263.341 54.4336 267.032 57.5195 269.766 61.2695C272.501 64.9805 273.868 68.6133 273.868 72.168C273.868 75.1758 272.774 77.7539 270.587 79.9023C268.438 82.0117 265.684 83.6328 262.325 84.7656C259.005 85.8984 255.548 86.4648 251.954 86.4648Z"  fill="currentColor"/>
          <path d="M290.328 119.746C288.766 119.746 287.496 119.219 286.52 118.164C285.543 117.148 285.055 115.762 285.055 114.004C285.055 112.363 285.25 110.723 285.641 109.082C286.07 107.48 286.812 105.703 287.867 103.75C288.883 101.797 290.23 99.6094 291.91 97.1875C293.629 94.8047 295.777 91.9922 298.355 88.75L310.074 65.0195C304.215 71.9727 298.902 77.2852 294.137 80.957C289.371 84.6289 284.918 86.4648 280.777 86.4648C279.449 86.4648 278.316 86.1523 277.379 85.5273C276.441 84.9414 275.973 83.9453 275.973 82.5391C275.973 80.5859 276.441 78.3789 277.379 75.918C278.16 74.0039 278.98 72.2266 279.84 70.5859C280.738 68.9062 281.656 67.1484 282.594 65.3125C283.57 63.3594 284.703 60.957 285.992 58.1055C287.281 55.2539 288.707 51.8359 290.27 47.8516C291.051 46.3281 292.066 45.2344 293.316 44.5703C294.566 43.8672 295.777 43.5156 296.949 43.5156C298.16 43.5156 299.176 43.8086 299.996 44.3945C300.855 44.9414 301.285 45.6836 301.285 46.6211C301.285 47.1289 301.207 47.5391 301.051 47.8516L290.328 70.1758C289.781 71.3477 289.508 72.2461 289.508 72.8711C289.508 73.457 289.742 73.75 290.211 73.75C290.641 73.75 291.188 73.5352 291.852 73.1055C292.516 72.6758 293.141 72.1875 293.727 71.6406L317.926 47.8516C319.879 46.2891 321.383 45.332 322.438 44.9805C323.492 44.6289 324.527 44.4531 325.543 44.4531C326.363 44.4531 326.949 44.7656 327.301 45.3906C327.652 45.9766 327.828 46.6016 327.828 47.2656C327.828 47.7734 327.73 48.2812 327.535 48.7891L314.41 76.1523C316.285 74.7461 318.434 73.3789 320.855 72.0508C323.277 70.6836 325.641 69.4531 327.945 68.3594C330.25 67.2656 332.203 66.4062 333.805 65.7812C335.406 65.1172 336.305 64.7852 336.5 64.7852C337.477 64.7852 338.336 65.1562 339.078 65.8984C339.82 66.6406 340.191 67.5781 340.191 68.7109C340.191 69.7266 339.801 70.8008 339.02 71.9336C338.277 73.0664 336.949 74.1602 335.035 75.2148C332.574 76.582 330.23 77.8516 328.004 79.0234C325.816 80.1953 323.98 81.1914 322.496 82.0117L318.336 84.3555C316.461 85.4492 314.723 86.6016 313.121 87.8125C311.559 89.0234 309.977 90.3711 308.375 91.8555C306.656 96.3477 305.035 100.312 303.512 103.75C302.027 107.188 301.109 109.238 300.758 109.902C297.594 116.465 294.117 119.746 290.328 119.746Z"  fill="currentColor"/>
          </svg>
          <Button variant="ghost" size="icon" onClick={toggleTheme} className="relative">
            <Sun className="h-5 w-5 rotate-0 scale-100 transition-transform duration-200 dark:-rotate-90 dark:scale-0" />
            <Moon className="absolute left-1/2 top-1/2 h-5 w-5 -translate-x-1/2 -translate-y-1/2 rotate-90 scale-0 transition-transform duration-200 dark:rotate-0 dark:scale-100" />
            <span className="sr-only">Toggle theme</span>
          </Button>
        </div>

        <div className="grid grid-cols-1 gap-6">
          <div>
            <ArticleInput onConvert={() => mutate()} />
              <h2 className="text-xl font-semibold mb-4 mt-12 text-foreground">Recent Conversions</h2>
              
                {articles?.map((article) => (
            <Card className="mt-6">
                  <ConversionStatus 
                    key={article.id}
                    article={article}
                    onDelete={() => mutate()}
                    isSelected={selectedArticle?.id === article.id}
                    onSelect={() => {
                      if (article.status === "completed" && article.audioUrl) {
                        setSelectedArticle(article);
                      }
                    }}
                  />
            </Card>
                ))}
              
          </div>
        </div>
      </div>

      {selectedArticle && selectedArticle.audioUrl && (
        <AudioPlayerOverlay
          title={selectedArticle.title}
          content={selectedArticle.content}
          audioUrl={selectedArticle.audioUrl}
        />
      )}
    </div>
  );
}
